name: Bicep Validate

on:
  pull_request:
    paths:
      - 'Bicep/**'
      - '.github/workflows/bicep-validate.yml'
  workflow_dispatch:

env:
  DOTNET_CLI_HOME: /tmp/dotnet
  BICEP_FILE: Bicep/main.bicep

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: What-if deployment
        uses: azure/cli@v1
        with:
          inlineScript: |
            if [ -z "$AZURE_RESOURCE_GROUP" ]; then
              echo "AZURE_RESOURCE_GROUP secret is required for Bicep validation." >&2
              exit 1
            fi

            az deployment group what-if \
              --resource-group "$AZURE_RESOURCE_GROUP" \
              --template-file "$BICEP_FILE" \
              ${BICEP_LOCATION:+--location "$BICEP_LOCATION"} \
              ${BICEP_PARAMETERS:+--parameters $BICEP_PARAMETERS}
        env:
          AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
          BICEP_LOCATION: ${{ secrets.AZURE_LOCATION }}
          BICEP_PARAMETERS: ${{ secrets.BICEP_PARAMETERS }}
